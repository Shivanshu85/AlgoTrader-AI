# Prometheus Alert Rules for Stock Price Prediction Platform

groups:
  # API Service Alerts
  - name: api_alerts
    interval: 30s
    rules:
      - alert: APIServiceDown
        expr: up{job="stock-api"} == 0
        for: 2m
        labels:
          severity: critical
          service: stock-api
          component: api
        annotations:
          summary: "API Service is down"
          description: "Stock API service has been down for more than 2 minutes"
          dashboard: "http://grafana:3000/d/stock-api-main"

      - alert: HighErrorRate
        expr: |
          (rate(predictions_total[5m]) - rate(predictions_total{job="stock-api"}[5m]) + rate(prediction_errors_total[5m]))
          / rate(predictions_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: stock-api
          component: api
        annotations:
          summary: "API error rate is high"
          description: "API error rate is above 5% (current: {{ $value | humanizePercentage }})"
          runbook: "http://wiki/runbooks/api-error-rate"

      - alert: HighLatency
        expr: |
          histogram_quantile(0.95, rate(http_requests_duration_seconds_bucket{job="stock-api"}[5m])) > 1
        for: 5m
        labels:
          severity: warning
          service: stock-api
          component: api
        annotations:
          summary: "API latency is high"
          description: "95th percentile latency is above 1 second (current: {{ $value | humanizeDuration }})"

      - alert: PredictionCacheHitRateLow
        expr: |
          rate(cache_hits_total[5m]) / (rate(cache_hits_total[5m]) + rate(cache_misses_total[5m])) < 0.5
        for: 10m
        labels:
          severity: info
          service: stock-api
          component: cache
        annotations:
          summary: "Prediction cache hit rate is low"
          description: "Cache hit rate is below 50% (current: {{ $value | humanizePercentage }})"

  # Database Alerts
  - name: database_alerts
    interval: 30s
    rules:
      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          service: postgres
          component: database
        annotations:
          summary: "PostgreSQL database is down"
          description: "PostgreSQL database has been unreachable for more than 1 minute"

      - alert: PostgreSQLHighConnections
        expr: |
          pg_stat_activity_count > 80
        for: 5m
        labels:
          severity: warning
          service: postgres
          component: database
        annotations:
          summary: "PostgreSQL has high connection count"
          description: "Connection count is {{ $value }} (threshold: 80)"

      - alert: PostgreSQLSlowQueries
        expr: |
          rate(pg_stat_statements_total_time[5m]) > 1000
        for: 5m
        labels:
          severity: warning
          service: postgres
          component: database
        annotations:
          summary: "PostgreSQL has slow queries"
          description: "Slow query time is {{ $value | humanizeDuration }}"

      - alert: PostgreSQLDiskSpace
        expr: |
          node_filesystem_avail_bytes{mountpoint="/var/lib/postgresql/data"} / node_filesystem_size_bytes < 0.1
        for: 10m
        labels:
          severity: critical
          service: postgres
          component: database
        annotations:
          summary: "PostgreSQL disk space is low"
          description: "Less than 10% disk space available ({{ $value | humanizePercentage }})"

  # Cache (Redis) Alerts
  - name: cache_alerts
    interval: 30s
    rules:
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: warning
          service: redis
          component: cache
        annotations:
          summary: "Redis is down"
          description: "Redis cache has been unreachable for more than 1 minute"

      - alert: RedisHighMemoryUsage
        expr: |
          redis_memory_used_bytes / redis_memory_max_bytes > 0.8
        for: 5m
        labels:
          severity: warning
          service: redis
          component: cache
        annotations:
          summary: "Redis memory usage is high"
          description: "Redis using {{ $value | humanizePercentage }} of max memory"

      - alert: RedisEvictions
        expr: |
          rate(redis_evicted_keys_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
          service: redis
          component: cache
        annotations:
          summary: "Redis is evicting keys"
          description: "Redis eviction rate: {{ $value | humanize }} keys/sec"

  # Model Alerts
  - name: model_alerts
    interval: 30s
    rules:
      - alert: ModelInferenceTimeHigh
        expr: |
          histogram_quantile(0.95, rate(model_inference_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
          service: stock-api
          component: model
        annotations:
          summary: "Model inference time is high"
          description: "95th percentile inference time: {{ $value | humanizeDuration }}"

      - alert: ModelPredictionConfidenceLow
        expr: |
          avg(model_prediction_confidence[5m]) < 0.7
        for: 10m
        labels:
          severity: info
          service: stock-api
          component: model
        annotations:
          summary: "Model prediction confidence is low"
          description: "Average confidence: {{ $value | humanizePercentage }}"

  # Resource Alerts
  - name: resource_alerts
    interval: 30s
    rules:
      - alert: HighCPUUsage
        expr: |
          (1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) by (instance)) > 0.8
        for: 5m
        labels:
          severity: warning
          service: system
          component: cpu
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value | humanizePercentage }}"

      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.85
        for: 5m
        labels:
          severity: warning
          service: system
          component: memory
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value | humanizePercentage }}"

      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
        for: 10m
        labels:
          severity: critical
          service: system
          component: disk
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "{{ $value | humanizePercentage }} disk space available"

  # Kubernetes Alerts (if deployed in K8s)
  - name: kubernetes_alerts
    interval: 30s
    rules:
      - alert: KubernetesNodeNotReady
        expr: |
          kube_node_status_condition{condition="Ready",status="true"} == 0
        for: 5m
        labels:
          severity: critical
          service: kubernetes
          component: node
        annotations:
          summary: "Kubernetes node is not ready"
          description: "Node {{ $labels.node }} is not ready"

      - alert: KubernetesPodCrashLooping
        expr: |
          rate(kube_pod_container_status_restarts_total[15m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: kubernetes
          component: pod
        annotations:
          summary: "Pod is crash looping"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting frequently"

      - alert: KubernetesPodNotHealthy
        expr: |
          (kube_pod_status_phase{phase=~"Failed|Unknown"} == 1 and kube_pod_status_phase{phase=~"Unknown|Failed"} > 0) > 0
        for: 5m
        labels:
          severity: warning
          service: kubernetes
          component: pod
        annotations:
          summary: "Pod is unhealthy"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is in {{ $labels.phase }} state"

      - alert: KubernetesStatefulsetReplicasMismatch
        expr: |
          kube_statefulset_status_replicas_ready != kube_statefulset_status_replicas
        for: 5m
        labels:
          severity: warning
          service: kubernetes
          component: statefulset
        annotations:
          summary: "StatefulSet replicas mismatch"
          description: "StatefulSet {{ $labels.statefulset }} has {{ $value }} ready replicas (desired: {{ $labels.desired }})"

  # Business Logic Alerts
  - name: business_alerts
    interval: 1m
    rules:
      - alert: NoNewPredictions
        expr: |
          increase(predictions_total[10m]) == 0
        for: 15m
        labels:
          severity: warning
          service: stock-api
          component: business
        annotations:
          summary: "No new predictions in the last 10 minutes"
          description: "The API has not processed any predictions"

      - alert: ModelVersionStale
        expr: |
          time() - model_version_timestamp_seconds > 86400 * 7
        for: 1h
        labels:
          severity: info
          service: stock-api
          component: model
        annotations:
          summary: "Model version is stale"
          description: "Current model is older than 7 days"
